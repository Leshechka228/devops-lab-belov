name: CI Pipeline

on:
  push:
    branches: [ main, master, develop, github-actions ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate shell scripts
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º shell —Å–∫—Ä–∏–ø—Ç—ã..."
        find . -name "*.sh" -type f | while read script; do
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ $script"
          if bash -n "$script"; then
            echo "‚úÖ $script - —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π"
          else
            echo "‚ùå $script - –æ—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞"
            exit 1
          fi
        done
        
    - name: Check file permissions
      run: |
        echo "üîí –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
        find . -name "*.sh" -type f | while read script; do
          if [ ! -x "$script" ]; then
            echo "‚ö†Ô∏è  $script –Ω–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º..."
            chmod +x "$script"
          fi
          echo "‚úÖ $script - –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π"
        done
        
    - name: Test deployment scripts
      run: |
        echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç—ã –¥–µ–ø–ª–æ—è..."
        [ -f "deploy.sh" ] && echo "‚úÖ deploy.sh —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" || echo "‚ùå deploy.sh –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        [ -f "install-frp.sh" ] && echo "‚úÖ install-frp.sh —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" || echo "‚ùå install-frp.sh –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        [ -f "install-nginx.sh" ] && echo "‚úÖ install-nginx.sh —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" || echo "‚ùå install-nginx.sh –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        [ -f "test.sh" ] && echo "‚úÖ test.sh —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" || echo "‚ùå test.sh –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        [ -f "check-system.sh" ] && echo "‚úÖ check-system.sh —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" || echo "‚ùå check-system.sh –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        
    - name: Validate configuration files
      run: |
        echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
        [ -f "nginx.conf" ] && echo "‚úÖ nginx.conf —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" || echo "‚ùå nginx.conf –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        [ -f "index.html" ] && echo "‚úÖ index.html —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" || echo "‚ùå index.html –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        
    - name: Run custom tests
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ç–µ—Å—Ç—ã..."
        if [ -f "test.sh" ]; then
          echo "‚úÖ test.sh –Ω–∞–π–¥–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã..."
          chmod +x test.sh
          ./test.sh
        else
          echo "‚ùå test.sh –Ω–µ –Ω–∞–π–¥–µ–Ω - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞"
          exit 1
        fi