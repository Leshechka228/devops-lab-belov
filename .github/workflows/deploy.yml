name: CD Pipeline

on:
  release:
    types: [published]
  workflow_dispatch:  # –†–∞–∑—Ä–µ—à–∞–µ–º —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

env:
  SSH_HOST: 'course.prafdin.ru'
  SSH_PORT: '2481'
  SSH_USERNAME: 'alexey'
  APP_DIR: '/home/alexey/devops-lab'
  ID: 'belov'
  PROXY: 'course.prafdin.ru'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run CI tests
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º..."
        chmod +x test.sh
        ./test.sh
        
    - name: Validate deployment files
      run: |
        echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –¥–µ–ø–ª–æ—è..."
        [ -f "index.html" ] && echo "‚úÖ index.html –≥–æ—Ç–æ–≤" || exit 1
        [ -f "nginx.conf" ] && echo "‚úÖ nginx.conf –≥–æ—Ç–æ–≤" || exit 1
        [ -f "deploy.sh" ] && echo "‚úÖ deploy.sh –≥–æ—Ç–æ–≤" || exit 1
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤ index.html –µ—Å—Ç—å –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        grep -q "belov" index.html && echo "‚úÖ –ò–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞ –≤ index.html" || exit 1
        grep -q "üöÄ" index.html && echo "‚úÖ –†–∞–∫–µ—Ç–∞ –≤ index.html" || exit 1
        
    - name: Deploy to VM via SSH
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ env.SSH_HOST }}
        port: ${{ env.SSH_PORT }}
        username: ${{ env.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ VM..."
          cd ${{ env.APP_DIR }}
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
          echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
          git fetch origin
          git reset --hard origin/github-actions
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞..."
          ls -la
          [ -f "index.html" ] && echo "‚úÖ index.html —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" || exit 1
          [ -f "deploy.sh" ] && echo "‚úÖ deploy.sh —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" || exit 1
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –Ω–∞ —Ü–µ–ª–µ–≤–æ–π –º–∞—à–∏–Ω–µ
          echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –Ω–∞ —Ü–µ–ª–µ–≤–æ–π –º–∞—à–∏–Ω–µ..."
          chmod +x test.sh
          ./test.sh
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π
          echo "üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π..."
          chmod +x deploy.sh
          ./deploy.sh
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          
    - name: Verify deployment
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
        APP_URL="http://app.${{ env.ID }}.${{ env.PROXY }}"
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º URL: $APP_URL"
        
        # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
        sleep 10
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
        if curl -s -f "$APP_URL" > /dev/null; then
          echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ"
        else
          echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É $APP_URL"
          exit 1
        fi
        
    - name: Notify success
      run: |
        echo "üéâ CD Pipeline –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: http://app.${{ env.ID }}.${{ env.PROXY }}"
