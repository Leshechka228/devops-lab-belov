name: CD Pipeline

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  SSH_HOST: 'course.prafdin.ru'
  SSH_PORT: '2481'
  SSH_USERNAME: 'alexey'
  APP_DIR: '/home/alexey/devops-lab'
  ID: 'belov'
  PROXY: 'course.prafdin.ru'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run pre-deployment tests
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º..."
        chmod +x test.sh
        ./test.sh
        echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!"
        
    - name: Deploy to production
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ env.SSH_HOST }}
        port: ${{ env.SSH_PORT }}
        username: ${{ env.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "üöÄ –ó–ê–ü–£–°–ö –î–ï–ü–õ–û–Ø –í ${{ github.event.inputs.environment || 'production' }}"
          echo "–í—Ä–µ–º—è: $(date)"
          echo "–í–µ—Ç–∫–∞: ${{ github.ref }}"
          echo "–ö–æ–º–º–∏—Ç: ${{ github.sha }}"
          
          cd ${{ env.APP_DIR }}
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
          git fetch origin
          git checkout github-actions
          git reset --hard origin/github-actions
          
          echo "üìã –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞:"
          ls -la
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –Ω–∞ —Ü–µ–ª–µ–≤–æ–π –º–∞—à–∏–Ω–µ
          echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ..."
          chmod +x test.sh
          if ./test.sh; then
            echo "‚úÖ –¢–µ—Å—Ç—ã –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã"
          else
            echo "‚ùå –¢–µ—Å—Ç—ã –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å"
            exit 1
          fi
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π
          echo "üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π..."
          chmod +x deploy.sh
          if ./deploy.sh; then
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è"
            exit 1
          fi
          
    - name: Verify deployment
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
        APP_URL="http://app.${{ env.ID }}.${{ env.PROXY }}"
        echo "URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: $APP_URL"
        
        # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
        sleep 15
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
        for i in {1..3}; do
          if curl -s -f "$APP_URL" > /dev/null; then
            echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ (–ø–æ–ø—ã—Ç–∫–∞ $i)"
            break
          else
            echo "‚ö†Ô∏è  –ü–æ–ø—ã—Ç–∫–∞ $i: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –µ—â–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ"
            sleep 5
          fi
        done
        
        # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        if curl -s -f "$APP_URL" > /dev/null; then
          echo "üéâ –î–ï–ü–õ–û–ô –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù!"
          echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ: $APP_URL"
        else
          echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫"
          exit 1
        fi
