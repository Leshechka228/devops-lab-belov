name: CD Pipeline

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  SSH_HOST: 'course.prafdin.ru'
  SSH_PORT: '2481'
  SSH_USERNAME: 'alexey'
  APP_DIR: '/home/alexey/devops-lab'
  ID: 'belov'
  PROXY: 'course.prafdin.ru'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to VM
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ env.SSH_HOST }}
        port: ${{ env.SSH_PORT }}
        username: ${{ env.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ${{ env.APP_DIR }}
          git pull origin github-actions
          chmod +x deploy.sh
          ./deploy.sh
    
    - name: Verify deployment
      run: |
        APP_URL="http://app.${{ env.ID }}.${{ env.PROXY }}"
        curl -s -f "$APP_URL" > /dev/null