name: CD Pipeline TEST

on:
  push:
    branches: [github-actions]
  workflow_dispatch:

env:
  SSH_HOST: 'course.prafdin.ru'
  SSH_PORT: '2481'
  SSH_USERNAME: 'alexey'
  APP_DIR: '/home/alexey/devops-lab'
  ID: 'belov'
  PROXY: 'course.prafdin.ru'

jobs:
  deploy-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Debug info
      run: |
        echo "üß™ –¢–ï–°–¢–û–í–´–ô CD PIPELINE"
        echo "Branch: ${{ github.ref }}"
        echo "SSH Host: ${{ env.SSH_HOST }}"
        echo "SSH Port: ${{ env.SSH_PORT }}"
        echo "App Dir: ${{ env.APP_DIR }}"
        
    - name: Validate deployment files
      run: |
        echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –¥–µ–ø–ª–æ—è..."
        ls -la
        [ -f "index.html" ] && echo "‚úÖ index.html –≥–æ—Ç–æ–≤" || echo "‚ùå index.html –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        [ -f "nginx.conf" ] && echo "‚úÖ nginx.conf –≥–æ—Ç–æ–≤" || echo "‚ùå nginx.conf –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        [ -f "deploy.sh" ] && echo "‚úÖ deploy.sh –≥–æ—Ç–æ–≤" || echo "‚ùå deploy.sh –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        
    - name: Simulate deployment
      run: |
        echo "üöÄ –°–ò–ú–£–õ–ò–†–£–ï–ú –î–ï–ü–õ–û–ô (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)"
        echo "–í —Ä–µ–∞–ª—å–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–æ –±—ã:"
        echo "1. SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${{ env.SSH_HOST }}:${{ env.SSH_PORT }}"
        echo "2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ deploy.sh –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ"
        echo "3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ http://app.${{ env.ID }}.${{ env.PROXY }}"
        
    - name: Test SSH connection (optional)
      run: |
        echo "üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å SSH —Ö–æ—Å—Ç–∞..."
        timeout 10 bash -c "echo > /dev/tcp/${{ env.SSH_HOST }}/${{ env.SSH_PORT }}" && \
          echo "‚úÖ SSH —Ö–æ—Å—Ç –¥–æ—Å—Ç—É–ø–µ–Ω" || \
          echo "‚ö†Ô∏è  SSH —Ö–æ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞)"
